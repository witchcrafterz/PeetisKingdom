
(function(){'use strict';function prepareRegex(index){return new RegExp('\\{'+index.toString()+'}','g');}
function format(str,args){_.forEach(args,function(arg,index){str=str.replace(prepareRegex(index),arg);});return str;}
String.prototype.format=function(args){if(args.constructor===Array){return format(this,args);}else{return format(this,arguments);}};})();(function(){'use strict';Math.clamp=function(value,lower,upper){return Math.max(Math.min(value,upper),lower);};var Game=function(){this.gravity={x:0,y:3000};};Game.prototype.Utils=function(){};Game.prototype.GUI=function(){};window.Game=new Game();})();(function(){'use strict';Game.Utils.BaseState=function(game){};Game.Utils.BaseState.prototype={getCameraDeadzone:function(){var yFactor=0.4;var xFactor=0.35;var x=this.game.width*xFactor;var y=this.game.height*yFactor;var width=this.game.width*(1-xFactor)-x;var height=this.game.height*(1-yFactor)-y;return new Phaser.Rectangle(x,y,width,height);}};})();(function(){'use strict';Game.Utils.FpsMeter=function(game,x,y){Phaser.Text.call(this,game,x,y);this.game.time.advancedTiming=true;this.fixedToCamera=true;return this;};Game.Utils.FpsMeter.prototype=Object.create(Phaser.Text.prototype);Game.Utils.FpsMeter.prototype.constructor=Game.Utils.FpsMeter;Game.Utils.FpsMeter.prototype.update=function(){this.text='FPS: '+this.game.time.fps;};})();(function(){'use strict';Game.Controller=function(game){this.game=game;var left=this.left={onDown:new Phaser.Signal(),onUp:new Phaser.Signal(),isDown:false,setDown:function(){left.isDown=true;left.onDown.dispatch('left',true);},setUp:function(){left.isDown=false;left.onUp.dispatch('left',false);}};var right=this.right={onDown:new Phaser.Signal(),onUp:new Phaser.Signal(),isDown:false,setDown:function(){right.isDown=true;right.onDown.dispatch('right',true);},setUp:function(){right.isDown=false;right.onUp.dispatch('right',false);}};var jump=this.jump={onDown:new Phaser.Signal(),onUp:new Phaser.Signal(),isDown:false,setDown:function(){jump.isDown=true;jump.onDown.dispatch('jump',true);},setUp:function(){jump.isDown=false;jump.onUp.dispatch('jump',false);}};var down=this.down={onDown:new Phaser.Signal(),onUp:new Phaser.Signal(),isDown:false,setDown:function(){down.isDown=true;down.onDown.dispatch('down',true);},setUp:function(){down.isDown=false;down.onUp.dispatch('down',false);}};var up=this.up={onDown:new Phaser.Signal(),onUp:new Phaser.Signal(),isDown:false,setDown:function(){up.isDown=true;up.onDown.dispatch('up',true);},setUp:function(){up.isDown=false;up.onUp.dispatch('up',false);}};return this;};Game.Controller.prototype.constructor=Game.Controller;Game.Controller.prototype.generateTouchControls=function(){this.touchControlsGroup=this.game.add.group();var dPad=this.game.add.button(0,0,'UI',null,null,6,6,6,6,this.touchControlsGroup);var jump=this.game.add.button(0,0,'UI',null,null,44,44,44,44,this.touchControlsGroup);dPad.scale.setTo(2);jump.scale.setTo(3);jump.x=this.game.width-jump.width;jump.y=this.game.height-jump.height;dPad.y=this.game.height-dPad.height;this.touchControlsGroup.fixedToCamera=true;this.touchControlsGroup.setAll('alpha',0.85);console.log(this.game.input);var onDownHandler=function(sender,pointer){var relativeX=pointer.x-sender.x;var deltaX=relativeX-sender.width/2;if(deltaX<0){this.left.setDown.call(this);}else{this.left.setUp.call(this);}
if(deltaX>=0){this.right.setDown.call(this);}else{this.right.setUp.call(this);}};var onDownLoop=function(sender,pointer){setTimeout(function(thisArg){if(pointer.isDown){onDownHandler.call(thisArg,sender,pointer);onDownLoop.call(thisArg,sender,pointer);}else{this.left.setUp.call(this);this.right.setUp.call(this);}},20,this);};dPad.onInputDown.add(onDownLoop,this);dPad.onInputUp.add(function(sender,pointer){this.left.setUp.call(this);this.right.setUp.call(this);},this);jump.onInputDown.add(this.jump.setDown,this);jump.onInputUp.add(this.jump.setUp,this);};})();(function(){'use strict';Game.ObjectiveManager=function(game,parent,x,y){Phaser.Group.call(this,game,parent,'ObjectiveManager');this.position.setTo(x,y);this.padding=10;this.animationSpeed=300;this.easing=Phaser.Easing.Quadratic.Out;var bmd=this.game.make.bitmapData(1,1);this.bg=new Phaser.Image(this.game,0,0,bmd);this.bg.bmd=bmd;this.bg.position.x=-this.padding*0.5;this.bg.position.y=-this.padding*0.5;this.add(this.bg);this.titleText=this.game.add.bitmapText(0,0,'font','Objectives');this.titleText.tint=0x010101;this.add(this.titleText);this.countText=this.game.add.bitmapText(0,0,'font','-1');this.countText.tint=0x010101;this.countText.visible=false;this.add(this.countText);this.objectives=[];this.objectiveLog=[];this.allObjectives=[];this.objectiveCompleteSFX=this.game.add.audio('objectComplete');this.onObjectiveComplete=new Phaser.Signal();this._expandButton=new Game.GUI.Button(this.game,0,10,undefined,'Hide','font');this._expandButton.anchor.setTo(0,0);this._expandButton.fontSize=26;this._expandButton.onInputDown.add(this.toggleExpand,this);this.add(this._expandButton);this._isExpanded=true;this._updatePositioning();this.onObjectiveComplete.add(this.onObjectiveCompleteHandler,this);this.alpha=0;};Game.ObjectiveManager.prototype=Object.create(Phaser.Group.prototype);Game.ObjectiveManager.prototype.constructor=Game.ObjectiveManager;Game.ObjectiveManager.prototype.onObjectiveCompleteHandler=function(){this.objectiveCompleteSFX.play();};Game.ObjectiveManager.prototype.toggleExpand=function(){this._isExpanded=!this._isExpanded;if(!this._isExpanded){_.forEach(this.objectives,function(objective,index){objective.alpha=0;},this);this._expandButton.text='Show';this.countText.visible=true;}else{_.forEach(this.objectives,function(objective,index){objective.alpha=1;},this);this._expandButton.text='Hide';this.countText.visible=false;}
this._updatePositioning();};Game.ObjectiveManager.prototype.createObjectives=function(map,objectivesLayer,player){_.forEach(objectivesLayer,function(objective){switch(objective.type){case'collect':this.allObjectives.push(this.createCollectObjective(map,objective,player));break;case'a2b':this.allObjectives.push(this.createA2BObjective(map,objective,player));break;case'criteria':this.allObjectives.push(this.createCriteriaObjective(map,objective,player));break;default:console.log('Objective of type '+objective.type+' not yet implemented');break;}},this);};Game.ObjectiveManager.prototype.createCollectObjective=function(map,objective,player){var activeRect=new Phaser.Rectangle(objective.x,objective.y,objective.width,objective.height);var trigger=new Game.Trigger.ZoneTrigger(this.game,true,activeRect,player);var objectLayer=map.objects[objective.properties.itemLayer];var itemsGroup=this.game.add.group(undefined,objective.name);itemsGroup.enableBody=true;var endTrigger;_.forEach(objectLayer,function(object){if(object.type&&object.type==='end'){endTrigger=new Game.Trigger.ZoneTrigger(this.game,true,new Phaser.Rectangle(object.x,object.y,object.width,object.height),player);}else{var key=object.properties.spritesheet||objective.properties.spritesheet;var frame=object.properties.frame||objective.properties.frame;var glow=object.properties.glow||objective.properties.glow;var sprite=itemsGroup.create(object.x+object.width*0.5,object.y+object.height*0.5,key,parseInt(frame));if(glow==='true'){var torchLight=new Game.Torch(this.game,sprite.width*0.5,sprite.height*0.5,100);this.game.add.existing(torchLight);sprite.addChild(torchLight);}
if(object.properties['activate']){sprite.activate=true;}
sprite.body.allowGravity=object.properties.allowGravity==='true'||false;}},this);var dependencies=objective.properties.dependencies?objective.properties.dependencies.split(','):undefined;var collectObjective=new Game.ObjectiveManager.CollectObjective(this.game,this,trigger,map,objective,player,dependencies,itemsGroup,endTrigger);this.game.triggerManager.addTrigger(trigger);if(endTrigger)this.game.triggerManager.addTrigger(endTrigger);return collectObjective;};Game.ObjectiveManager.prototype.createA2BObjective=function(map,objective,player){var activeRect=new Phaser.Rectangle(objective.x,objective.y,objective.width,objective.height);var trigger=new Game.Trigger.ZoneTrigger(this.game,true,activeRect,player);var endLayer=map.objects[objective.properties.endLayer];var rectangles=[];_.forEach(endLayer,function(object){rectangles.push(new Phaser.Rectangle(object.x,object.y,object.width,object.height));});var endTrigger=new Game.Trigger.ZoneTrigger(this.game,false,rectangles,player);var dependencies=objective.properties.dependencies?objective.properties.dependencies.split(','):undefined;var a2bObjective=new Game.ObjectiveManager.A2BObjective(this.game,this,trigger,map,objective,player,dependencies,endTrigger);this.game.triggerManager.addTrigger(trigger);this.game.triggerManager.addTrigger(endTrigger);return a2bObjective;};Game.ObjectiveManager.prototype.createCriteriaObjective=function(map,objective,player){var activeRect=new Phaser.Rectangle(objective.x,objective.y,objective.width,objective.height);var trigger=new Game.Trigger.ZoneTrigger(this.game,true,activeRect,player);var dependencies=objective.properties.dependencies?objective.properties.dependencies.split(','):undefined;var criterias=objective.properties.criterias?objective.properties.criterias.split(','):[];var criteriaObjective=new Game.ObjectiveManager.CriteriaObjective(this.game,this,trigger,map,objective,player,dependencies,criterias);this.game.triggerManager.addTrigger(trigger);return criteriaObjective;};Game.ObjectiveManager.prototype.addObjective=function(objective){objective.y=this._calculateHeightTo(this.objectives.length-1);this.objectives.push(objective);this.objectiveLog.push(objective);if(this._isExpanded){objective.game.add.tween(objective).to({alpha:1},this.animationSpeed,this.easing,true);}
objective.onCompletion.add(this._removeObjective,this);objective.onFailure.add(this._removeObjective,this);this.countText.text=String(this.objectives.length);this._updatePositioning();};Game.ObjectiveManager.prototype.isActive=function(objective){return _.contains(this.objectives,objective);};Game.ObjectiveManager.prototype.isCompleted=function(objectives){if(!objectives)return true;if(objectives.constructor===String)objectives=objectives.split(',');var toCheck=_.filter(this.allObjectives,function(objective){return _.contains(objectives,objective.properties.id);});if(toCheck.length<objectives.length){console.log('Could not find all dependencies. Did you spell all correctly?');return false;}
return _.every(toCheck,'completed');};Game.ObjectiveManager.prototype._removeObjective=function(objective){if(!objective.isActive)return;objective.game.add.tween(objective).to({alpha:0},this.animationSpeed,this.easing,true);var index=this.objectives.indexOf(objective);this.objectives.splice(index,1);this._updatePositioning();this.countText.text=String(this.objectives.length);};Game.ObjectiveManager.prototype._updatePositioning=function(){if(this.objectives.length===0){this.game.add.tween(this).to({alpha:0},this.animationSpeed,this.easing,true);return;}else{this.game.add.tween(this).to({alpha:1},this.animationSpeed,this.easing,true);}
this.pivot.x=this._getVisibleWidth()*0.5;this.game.add.tween(this.titleText.position).to({x:this._getVisibleWidth()*0.5-this.titleText.width*0.5},this.animationSpeed,this.easing,true);this._expandButton.position.x=this._getVisibleWidth()-this._expandButton.width;_.forEach(this.objectives,function(objective,index){this.game.add.tween(objective).to({y:this._calculateHeightTo(index-1)},this.animationSpeed,this.easing,true);},this);this.bg.width=this._getVisibleWidth()+this.padding;this.bg.height=this._calculateHeightTo(this._isExpanded?this.objectives.length-1:-1)+this.padding;this.bg.bmd.clear();this.bg.bmd.fill(255,255,255,0.75);};Game.ObjectiveManager.prototype._calculateHeightTo=function(index){var _height=this.titleText.height+this.padding;index=Math.min(this.objectives.length-1,index);for(var i=0;i<=index;i++){_height+=this.objectives[i].height+this.padding;}
return _height;};Game.ObjectiveManager.prototype._getVisibleWidth=function(){var width=0;for(var i=0;i<this.objectives.length;i++){width=Math.max(width,this.objectives[i].width);}
return width;};})();(function(){'use strict';Game.ObjectiveManager.Objective=function(game,objectiveManager,trigger,tilemap,object,player,dependencies){Phaser.Group.call(this,game,objectiveManager,object.name);this.alpha=0;this.game=game;this.player=player;this.objectiveManager=objectiveManager;this.object=object;this.properties=this.object.properties;this.tilemap=tilemap;this.name=this.object.name;this.completed=false;this.dependencies=dependencies;this.trigger=trigger;this.trigger.onActive.add(this.activate,this);this.trigger.onInactive.add(this.inactivate,this);this.removeOnInactive=false;this.onCompletion=new Phaser.Signal();this.onCompletion.add(this._onCompletionHandler,this);this.onCompleteArgs=this.properties['onCompleteArgs']?this.properties['onCompleteArgs'].split(','):[];this.onCompleteArgs.splice(0,0,this.object);this.onFailure=new Phaser.Signal();this.onFailure.add(this._onFailureHandler,this);this._titleTextStyle={font:'17pt serif'};this._titleText=this.game.add.bitmapText(0,0,'font',this.name,28);this._titleText.tint=0x010101;this.add(this._titleText);this._statusTextStyle={font:'14pt serif'};this._onComplete=(this.properties['onComplete']||'').split(',');this._statusTemplate=(this.object.properties.status||this.name).replace('\\n','\n');this._statusText=this.game.add.bitmapText(20,0,'font',this._statusTemplate,23);this._statusText.tint=0x010101;this._statusText.y=this._titleText.height;this.add(this._statusText);};Game.ObjectiveManager.Objective.prototype=Object.create(Phaser.Group.prototype);Game.ObjectiveManager.Objective.prototype.constructor=Game.ObjectiveManager.Objective;Game.ObjectiveManager.Objective.prototype.update=function(){Phaser.Group.prototype.update.call(this);};Game.ObjectiveManager.Objective.prototype.updateStatusText=function(){};Game.ObjectiveManager.Objective.prototype.activate=function(){if(!this.isActive&&!this.completed&&this.objectiveManager.isCompleted(this.dependencies)){this.objectiveManager.addObjective(this);}};Game.ObjectiveManager.Objective.prototype.inactivate=function(){if(this.removeOnInactive&&this.isActive){this.objectiveManager._removeObjective(this);}};Object.defineProperty(Game.ObjectiveManager.Objective.prototype,'statusTemplate',{get:function(){return this._statusTemplate;},set:function(value){this._statusTemplate=value;this.updateStatusText();}});Game.ObjectiveManager.Objective.prototype._onCompletionHandler=function(){this.completed=true;this._statusTextStyle.fill='#01C611';this._statusText.setStyle(this._statusTextStyle);this.objectiveManager.onObjectiveComplete.dispatch(this);this._callOnCompletionTriggers();};Game.ObjectiveManager.Objective.prototype._callOnCompletionTriggers=function(){var state=this.game.state.getCurrentState();var triggerFunctions=state.triggerFunctions;var key;for(var i=0;i<this._onComplete.length;i++){key=this._onComplete[i];if(triggerFunctions[key]){console.log(triggerFunctions[key]);triggerFunctions[key].apply(state,this.onCompleteArgs);}}};Game.ObjectiveManager.Objective.prototype._onFailureHandler=function(){this._statusTextStyle.fill='#ff0000';this._statusText.setStyle(this._statusTextStyle);};Game.ObjectiveManager.Objective.prototype.toString=function(){return this.name;};Object.defineProperty(Game.ObjectiveManager.Objective.prototype,'statusText',{get:function(){if(this._statusText){return this._statusText.text;}
return this.name+' status';},set:function(value){this._statusText.text=value.replace('\\n','\n');}});Object.defineProperty(Game.ObjectiveManager.Objective.prototype,'isActive',{get:function(){return this.objectiveManager.isActive(this);}});})();(function(){'use strict';Game.Character=function(game,x,y,texture,controller){Phaser.Sprite.call(this,game,x,y,texture);this.anchor.set(0.5);this.game.physics.enable(this,Phaser.Physics.ARCADE);this.body.drag=new Phaser.Point(1500,0);this.body.maxVelocity=new Phaser.Point(3000,2000);this.desiredDrag=this.body.drag.clone();this.desiredAirDrag=new Phaser.Point(300,0);this.textureKey=texture;this.maxJumps=1;this.walkingVelocity=500;this.controller=controller;this.walkingAcc=2000;this.fullJumpMeter=20000;this.jumpFactor=0.7;this.jumpMeter=this.fullJumpMeter;this.currentJumps=0;this.states={'airborn':false,'walking':false,'tryWalking':false,'falling':false,'rising':false,'still':false,'ducking':false};this.autoFlip=true;this.jumpSFX=this.game.add.audio('jump');this.thudSFX=this.game.add.audio('thud');this.footstepSFX=this.game.add.audio('footstep');this.stepsPerSecond=3;this.godMode=false;this._data={prevY:-1,lastStep:-1};this.groundEmitter=this.game.add.emitter(this.width*0.5,this.height);this.groundEmitter.makeParticles('dirtParticle',0,100);this.groundEmitter.setXSpeed(-500,500);this.groundEmitter.setYSpeed(-1000,-500);return this;};Game.Character.prototype=Object.create(Phaser.Sprite.prototype);Game.Character.prototype.constructor=Game.Character;Game.Character.prototype.resetJump=function(){var deltaVel=this._data.prevY-this.body.velocity.y;if(deltaVel>1200){var particles=(deltaVel-1200)*0.05;this.groundEmitter.explode(1000,particles);this.thudSFX.playFrom(this.position);}
this.currentJumps=0;this.jumpMeter=this.fullJumpMeter;this.flicked=false;};Game.Character.prototype._jump=function(){if(this.submerged||this.climbing){if(this.controller.jump.isDown){this.body.velocity.y=-400;}
return;}
if(this.controller.jump.isDown){if(!this.jumpWasDown){this.currentJumps+=1;if(this.currentJumps<this.maxJumps){this.body.velocity.y=0;}}
if(Math.floor(this.jumpMeter)>0&&this.currentJumps<this.maxJumps){if(this.body.onFloor()||!this.jumpWasDown){this.jumpSFX.playFrom(this.position);}
this.body.acceleration.y-=this.jumpMeter;this.jumpMeter*=this.jumpFactor;}}else{if(this.jumpWasDown){if(this.maxJumps>=this.currentJumps){this.jumpMeter=this.fullJumpMeter;}else{this.jumpMeter=0;}}}
this.jumpWasDown=this.controller.jump.isDown;};Game.Character.prototype._calculateStates=function(){this.states.airborn=!this.body.onFloor();this.states.falling=this.states.airborn&&this.body.velocity.y>0;this.states.rising=this.states.airborn&&this.body.velocity.y<0;if(this.controller){this.states.tryWalking=(this.controller.right.isDown||this.controller.left.isDown);this.states.walking=this.states.tryWalking&&!this.states.airborn;this.states.still=(this.body.touching.down||this.body.onFloor())&&Math.abs(this.body.velocity.x)<40;this.states.ducking=this.controller.down.isDown;}else{this.states.walking=undefined;this.states.still=undefined;this.states.ducking=undefined;}};Game.Character.prototype._controllerHandler=function(){if(this.controller.update){this.controller.update();}
if(this.controller.right.isDown){this.body.acceleration.x=this.walkingAcc;if(this.autoFlip){this.scale.x=1;}}else if(this.controller.left.isDown){this.body.acceleration.x=-this.walkingAcc;if(this.autoFlip){this.scale.x=-1;}}else{this.body.acceleration.setTo(0);}
if(!this.godMode){this._jump();}else{if(this.controller.jump.isDown){this.body.acceleration.y=-2000;}else if(this.controller.down.isDown){this.body.acceleration.y=2000;}else{this.body.velocity.y*=0.95;}}};Game.Character.prototype._setData=function(){this._data.prevY=this.body.velocity.y;};Game.Character.prototype.updateEmitters=function(){this.groundEmitter.emitX=this.position.x;this.groundEmitter.emitY=this.position.y+this.body.height;};Game.Character.prototype.update=function(){this._calculateStates();this.body.acceleration.setTo(0);this.updateEmitters();if(this.controller){this._controllerHandler();}
if(this.states.airborn){if(!this.body.drag.equals(this.desiredAirDrag)){this.body.drag.setTo(this.desiredAirDrag.x,this.desiredAirDrag.y);}}else{if(!this.body.drag.equals(this.desiredDrag)){this.body.drag.setTo(this.desiredDrag.x,this.desiredDrag.y);}}
if(this.states.walking&&this.game.time.now-this._data.lastStep>1000/this.stepsPerSecond){this.footstepSFX.playFrom(this.position);this._data.lastStep=this.game.time.now;}
if(this.submerged||this.climbing){this.body.velocity.y*=0.85;this.body.velocity.x*=0.95;}
if(this.body.onFloor()||this.body.touching.down){this.resetJump();}
if(this.states.tryWalking&&!this.godMode&&!this.flicked){this.body.velocity.x=Math.clamp(this.body.velocity.x,-this.walkingVelocity,this.walkingVelocity);}
this._setData();};})();(function(){'use strict';Game.Controller.AI=function(game,controlled,player,properties){Game.Controller.call(this,game);this.controlled=controlled;this.player=player;this.properties=properties;this.friendlyDependencies=this.properties['dependencies']?this.properties['dependencies'].split(','):undefined;this.dependenciesComplete=typeof this.friendlyDependencies==='undefined';this.friendlyCriterias=this.properties['criterias']?this.properties['criterias'].split(','):undefined;this.criteriasComplete=typeof this.friendlyCriterias==='undefined';this.dialogue=this.game.dialogues[this.properties['dialogue']];this.isPlayerClose=false;this.wasPlayerClose=false;this.vision=parseInt(this.properties.vision,10)||200;this.watchPlayer=true;this._dependenciesMonitor();this._criteriasMonitor();return this;};Game.Controller.AI.prototype=Object.create(Game.Controller.prototype);Game.Controller.AI.prototype.constructor=Game.Controller.AI;Game.Controller.AI.prototype.update=function(){var deltaX=this.controlled.position.x-this.player.position.x;var deltaY=this.controlled.position.y-this.player.position.y;var distanceSq=deltaX*deltaX+deltaY*deltaY;if(distanceSq<this.vision*this.vision){this.isPlayerClose=true;this._onCloseHandler();}else{this.isPlayerClose=false;this._onNotCloseHandler();}
if(this.isPlayerClose&&this.watchPlayer&&this.controlled.autoFlip){var dir=this.controlled.position.x>this.player.position.x?-1:1;this.controlled.scale.x=dir;}
this.wasPlayerClose=this.isPlayerClose;};Game.Controller.AI.prototype._onCloseHandler=function(){if(!this.wasPlayerClose&&this.dialogue){this.game.dialogueManager.setDialogue(this.dialogue);}};Game.Controller.AI.prototype._onNotCloseHandler=function(){if(this.wasPlayerClose&&this.dialogue&&this.dialogue.isOpen){this.game.dialogueManager.hidden=true;this.dialogue.isOpen=false;}};Game.Controller.AI.prototype._dependenciesMonitor=function(){if(this.friendlyDependencies){this.game.objectiveManager.onObjectiveComplete.add(function(){this.dependenciesComplete=this.game.objectiveManager.isCompleted(this.friendlyDependencies);this._dependenciesCompleteHandler();},this);}};Game.Controller.AI.prototype._dependenciesCompleteHandler=function(){};Game.Controller.AI.prototype._criteriasMonitor=function(){if(this.friendlyCriterias){this.game.onCriteriaAdd.add(function(){this.criteriasComplete=_.difference(this.friendlyCriterias,this.game.criterias).length===0;this._criteriasCompleteHandler();},this);}};Game.Controller.AI.prototype._criteriasCompleteHandler=function(){};})();(function(){'use strict';Game.Controller.AI.Guard=function(game,controlled,player,properties){Game.Controller.AI.call(this,game,controlled,player,properties);this.hostile=true;var angle=parseFloat(this.properties['angle'],10)||Math.PI/4;var magnitude=parseInt(this.properties['magnitude'],10)||1500;this.flickVector=new Phaser.Point(Math.cos(angle)*magnitude,-Math.sin(angle)*magnitude);return this;};Game.Controller.AI.Guard.prototype=Object.create(Game.Controller.AI.prototype);Game.Controller.AI.Guard.prototype.constructor=Game.Controller.AI.Guard;Game.Controller.AI.Guard.prototype.update=function(){Game.Controller.AI.prototype.update.call(this);if(!this.hostile||(this.criteriasComplete&&this.dependenciesComplete)&&(this.friendlyCriterias||this.friendlyDependencies)){this.right.setUp();this.left.setUp();this.jump.setUp();return;}
if(this.game.physics.arcade.intersects(this.player.body,this.controlled.body)){this.player.body.position.y-=10;this.player.body.velocity.setTo(this.flickVector.x,this.flickVector.y);this.player.flicked=true;}};})();(function(){'use strict';Game.Controller.AI.Ornithologist=function(game,controlled,player,properties){Game.Controller.AI.Guard.apply(this,arguments);this.range=parseInt(properties.range,10)||100;this.defaultPosition=controlled.position.clone();this.controlled.walkingVelocity=750;this.controlled.walkingAcc=3000;return this;};Game.Controller.AI.Ornithologist.prototype=Object.create(Game.Controller.AI.Guard.prototype);Game.Controller.AI.Ornithologist.prototype.constructor=Game.Controller.AI.Ornithologist;Game.Controller.AI.Ornithologist.prototype.update=function(){Game.Controller.AI.Guard.prototype.update.call(this);if(!this.hostile)return;var left,right,jump;if(this.range&&Math.abs(this.defaultPosition.x-this.player.body.position.x)<this.range&&Math.abs(this.defaultPosition.y-this.player.body.position.y)<this.range){left=this.controlled.body.position.x-this.player.body.position.x>0;right=this.controlled.body.position.x-this.player.body.position.x<0;}else{left=this.controlled.body.position.x-this.defaultPosition.x>100;right=this.controlled.body.position.x-this.defaultPosition.x<-100;}
jump=(left||right)&&(this.controlled.position.y-this.player.position.y>100);if(left){this.left.setDown();this.right.setUp();}else if(right){this.left.setUp();this.right.setDown();}else{this.right.setUp();this.left.setUp();}
if(this.controlled.body.blocked.left||this.controlled.body.blocked.right||jump){this.jump.setDown();}else{this.jump.setUp();}};})();(function(){'use strict';Game.Controller.AI.Pacing=function(game,controlled,player,properties){Game.Controller.AI.call(this,game,controlled,player,properties);this.range=parseInt(properties.range,10)||100;this.defaultPosition=controlled.position.clone();this.rnd=this.game.state.getCurrentState().rnd;this.threshold=0;this.thresholdInc=0.00005;return this;};Game.Controller.AI.Pacing.prototype=Object.create(Game.Controller.AI.prototype);Game.Controller.AI.Pacing.prototype.constructor=Game.Controller.AI.Pacing;Game.Controller.AI.Pacing.prototype.update=function(){Game.Controller.AI.prototype.update.call(this);if(this.isPlayerClose)return;if(this.rnd.frac()<this.threshold){var dirValue=this.rnd.normal();var dirThreshold=(this.controlled.position.x-this.defaultPosition.x)/this.range;var dir=dirValue<dirThreshold;if(dir){this.right.setUp();this.left.setDown();}else{this.left.setUp();this.right.setDown();}
setTimeout(this.stopWalk.bind(this),150);this.threshold=0;}else{this.threshold+=this.thresholdInc;}
if(this.controlled.body.blocked.left||this.controlled.body.blocked.right){this.jump.setDown();}else{this.jump.setUp();}};Game.Controller.AI.Pacing.prototype.stopWalk=function(){this.right.setUp();this.left.setUp();};})();(function(){'use strict';Game.Controller.KeyboardController=function(game,controlled){Game.Controller.call(this,game);this.controlled=controlled;this.cursors=this.game.input.keyboard.createCursorKeys();this.spaceBar=this.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);if(Modernizr.touchevents){this.generateTouchControls();}
this.bindKeys();return this;};Game.Controller.KeyboardController.prototype=Object.create(Game.Controller.prototype);Game.Controller.KeyboardController.prototype.constructor=Game.Controller.KeyboardController;Game.Controller.KeyboardController.prototype.bindKeys=function(){this.cursors.right.onDown.add(this.right.setDown);this.cursors.right.onUp.add(this.right.setUp);this.cursors.left.onDown.add(this.left.setDown);this.cursors.left.onUp.add(this.left.setUp);this.spaceBar.onDown.add(this.jump.setDown);this.spaceBar.onUp.add(this.jump.setUp);this.cursors.down.onDown.add(this.down.setDown);this.cursors.down.onUp.add(this.down.setUp);this.cursors.up.onDown.add(this.up.setDown);this.cursors.up.onUp.add(this.up.setUp);};})();(function(){'use strict';Game.Dialogue=function(game,conversation,title,textStyle,titleStyle,sprite,background){this.game=game;this.conversation=conversation;if(conversation.constructor!==Array){this.conversation=[this.conversation];}
this.nSlides=this.conversation.length;this.currentSlide=-1;this.defaultTitle=title;this.defaultSprite=sprite;this.defaultTextStyle=textStyle;this.defaulTitleStyle=titleStyle;this.defaultBackground=background;this.isOpen=false;return this;};Game.Dialogue.prototype.constructor=Game.Dialogue;})();(function(){'use strict';Game.DialogueManager=function(game,parent){this.game=game;this.parent=parent;this.easing=Phaser.Easing.Power2;this.height=200;this.width=975;this.padding=20;this._hidden=true;this.dialoguePanel=this.game.add.group(this.parent,'Dialogue Panel');this.dialoguePanel.x=this.game.width*0.2;this.dialoguePanel.y=this.game.height;this._background=new Phaser.Sprite(this.game,this.game.width*0.5-this.dialoguePanel.x,0,'');this._background.anchor.setTo(0.5,0);this.dialoguePanel.add(this._background);this.titleText=new Phaser.BitmapText(this.game,0,0,'font','title',50);this.titleText.tint=0x010101;this.titleText.y=this.padding;this.defaultTextFontSize=this.titleText.fontSize*0.8;this.textText=new Phaser.BitmapText(this.game,0,0,'font','text',this.defaultTextFontSize);this.textText.tint=0x010101;this.textText.maxWidth=1000;this.pageText=new Phaser.BitmapText(this.game,0,0,'font','0/0',this.titleText.fontSize*0.6);this.pageText.tint=0x010101;this.currentDialogue=null;this.defaultTitleStyle={font:'bold 24pt serif'};this.defaultTextStyle={font:'20pt serif'};this.defaultBackground='dialoguePanel';this.dialoguePanel.add(this.titleText);this.dialoguePanel.add(this.textText);this.dialoguePanel.add(this.pageText);return this;};Game.DialogueManager.prototype.constructor=Game.DialogueManager;Game.DialogueManager.prototype.setDialogue=function(dialogue,autoShow,reset){if(this.currentDialogue){this.currentDialogue.isOpen=false;}
this.currentDialogue=dialogue;autoShow=typeof autoShow!=='undefined'?autoShow:true;reset=typeof reset!=='undefined'?reset:true;if(reset===true){this.currentDialogue.currentSlide=-1;}
if(autoShow){this.hidden=false;}
this.nextSlide();};Game.DialogueManager.prototype.nextSlide=function(){if(!this.currentDialogue)return;this.currentDialogue.currentSlide++;if(this.currentDialogue.currentSlide===this.currentDialogue.conversation.length){this.hidden=true;this.currentDialogue.currentSlide=-1;}else{this.refreshDialogue();}
this.currentDialogue.isOpen=!this.hidden;};Game.DialogueManager.prototype.refreshDialogue=function(){var currentSlide=this.currentDialogue.conversation[this.currentDialogue.currentSlide];this.titleText.text=currentSlide.title||this.currentDialogue.defaultTitle||'';this.textText.text=currentSlide.text||this.currentDialogue.defaultText||'';this.textText.fontSize=currentSlide.fontSize||currentSlide.fontScale*this.defaultTextFontSize||this.defaultTextFontSize;this.textText.y=this.height*0.5;var newBG=currentSlide.background||this.currentDialogue.defaultBackground||this.defaultBackground;if(this._background.key!==newBG){this._background.loadTexture(newBG);if(!this.hidden){this.hidden=false;}}
this.pageText.text='Page {0}/{1}'.format(this.currentDialogue.currentSlide+1,this.currentDialogue.conversation.length);this.pageText.updateTransform();this.pageText.y=this.height;this.pageText.x=this.width-this.pageText.width;};Object.defineProperty(Game.DialogueManager.prototype,'hidden',{get:function(){return this._hidden;},set:function(value){this._hidden=value;if(this._hidden){var add=this.padding;this.game.add.tween(this.dialoguePanel.position).to({y:this.game.height+add},1000,this.easing).start().onComplete.add(function(){if(this._hidden){this.dialoguePanel.visible=false;}},this);}else{this.dialoguePanel.visible=true;this.game.add.tween(this.dialoguePanel.position).to({y:this.game.height-this.dialoguePanel.height-this.padding},1000,this.easing).start();}}});})();(function(){'use strict';var _textureKey='alienYellow';var maxSpeed=500;var acc=2000;var controller=Game.Controller.AI;var maxVelocity=new Phaser.Point(3000,2000);var maxWalkingVelocity=new Phaser.Point(500,0);Game.Enemy=function(game,x,y,textureKey,controller){Phaser.Sprite.call(this,game,x,y,_textureKey||textureKey);this.anchor.set(0.5);this.game.physics.enable(this,Phaser.Physics.ARCADE);this.body.collideWorldBounds=true;this.body.drag.setTo(1000,0);this.body.maxVelocity=maxVelocity;this.controller=controller;this.controller.controlled=this;this.animations.add('running',[9,10],10,true);this.animations.add('jump',[5],20,true);this.animations.add('falling',[4],20,true);this.animations.add('still',[0],20,true);this.currAnim='';var point=new Phaser.Point();point.x=500;point.y=1000;this.body.maxVelocity=point;return this;};Game.Enemy.prototype=Object.create(Phaser.Sprite.prototype);Game.Enemy.prototype.constructor=Game.Enemy;Game.Enemy.prototype.animate=function(){};Game.Enemy.prototype.update=function(){if(this.controller.right.isDown){this.body.acceleration.x=acc;this.body.velocity.x=Math.clamp(this.body.velocity.x,-maxWalkingVelocity.x,maxWalkingVelocity.x);this.animations.play('running');this.scale.x=1;}else if(this.controller.left.isDown){this.body.acceleration.x=-acc;this.body.velocity.x=Math.clamp(this.body.velocity.x,-maxWalkingVelocity.x,maxWalkingVelocity.x);this.animations.play('running');this.scale.x=-1;}else{this.body.acceleration.setTo(0);}
if(this.body.onFloor()&&this.controller.jump.isDown){this.body.velocity.y-=2000;}};})();(function(){'use strict';Game.GUI.Button=function(game,x,y,key,text,fontKey,callback,callbackContext,overFrame,outFrame,downFrame,upFrame){Phaser.Button.call(this,game,x,y,key,callback,callbackContext,overFrame,outFrame,downFrame,upFrame);this._text=text;this._bmpText=new Phaser.BitmapText(this.game,0,0,fontKey,this._text,60);this._bmpText.align='center';this.addChild(this._bmpText);this.anchor.setTo(0.5);this.fontTint=0x010101;this._refresh();};Game.GUI.Button.prototype=Object.create(Phaser.Button.prototype);Game.GUI.Button.prototype.constructor=Game.GUI.Button;Game.GUI.Button.prototype._refresh=function(){this._bmpText.x=this._bmpText.width*-0.5;this._bmpText.y=this._bmpText.height*-0.5;};Object.defineProperty(Game.GUI.Button.prototype,'text',{get:function(){return this._bmpText.text;},set:function(value){this._bmpText.text=value;this._bmpText.updateTransform();this._refresh();}});Object.defineProperty(Game.GUI.Button.prototype,'fontTint',{get:function(){return this._bmpText.tint;},set:function(value){this._bmpText.tint=value;}});Object.defineProperty(Game.GUI.Button.prototype,'fontSize',{get:function(){return this._bmpText.fontSize;},set:function(value){this._bmpText.fontSize=value;this._bmpText.updateTransform();this._refresh();}});})();(function(){'use strict';Game.GUI.HelpScreen=function(game,parent){Phaser.Group.call(this,game,parent,'HelpScreen');this.padding=20;var bmd=this.game.make.bitmapData(this.game.width,this.game.height);bmd.fill(0,0,0,0.75);this.bg=new Phaser.Image(this.game,0,0,bmd);this.bg.bmd=bmd;this.add(this.bg);this.closeHelpBtn=new Game.GUI.Button(this.game,this.game.width,this.padding,'knapp','Close','font',this.closeHelp,this);this.closeHelpBtn.scale.setTo(0.4);this.closeHelpBtn.position.x-=(this.closeHelpBtn.width*0.5+20);this.closeHelpBtn.position.y+=40;this.add(this.closeHelpBtn);this.helpText='Controls: \n\n'+'      Walk: Left/Right arrow key\n'+'Jump/Climb: Spacebar\n'+' Next Page: Up arrow key';this.helpBitmapText=this.game.add.bitmapText(0,this.closeHelpBtn.y+this.closeHelpBtn.height+this.padding,'font',this.helpText,32,this);this.helpBitmapText.position.x=this.game.width*0.5-this.helpBitmapText.width*0.5;this.alpha=0;this.game.add.tween(this).to({alpha:1},300).start();};Game.GUI.HelpScreen.prototype=Object.create(Phaser.Group.prototype);Game.GUI.HelpScreen.prototype.constructor=Game.GUI.HelpScreen;Game.GUI.HelpScreen.prototype.closeHelp=function(){this.game.add.tween(this).to({alpha:0},300).start().onComplete.add(function(){if(this.game)this.game.state.getCurrentState().closeHelp();},this);};})();(function(){'use strict';Game.GUI.PauseScreen=function(game,parent){Phaser.Group.call(this,game,parent,'PauseScreen');this.padding=20;var bmd=this.game.make.bitmapData(this.game.width,this.game.height);bmd.fill(0,0,0,0.75);this.bg=new Phaser.Image(this.game,0,0,bmd);this.bg.bmd=bmd;this.add(this.bg);this.resumeBtn=new Game.GUI.Button(this.game,this.game.width*0.5,this.game.height*0.4,'knapp','Resume','font',this.resume,this);this.resumeBtn.scale.setTo(0.8);this.add(this.resumeBtn);this.multiplayerBtn=new Game.GUI.Button(this.game,this.game.width*0.5,this.resumeBtn.position.y+this.resumeBtn.height+this.padding,'knapp','Multiplayer:\noff','font',this.toggleMultiplayer,this);this.multiplayerBtn.scale.setTo(0.8);this.multiplayerBtn.position.x-=(this.multiplayerBtn.width+this.padding)*0.5;this.add(this.multiplayerBtn);this.musicBtn=new Game.GUI.Button(this.game,this.game.width*0.5,this.multiplayerBtn.position.y+this.multiplayerBtn.height+this.padding,'knapp','music_btn','font',this.toggleMusic,this);this.musicBtn.scale.setTo(0.8);this.musicBtn.position.x-=(this.musicBtn.width+this.padding)*0.5;this._refreshMusicBtn();this.add(this.musicBtn);this.toggleMuteBtn=new Game.GUI.Button(this.game,this.game.width*0.5,this.musicBtn.position.y,'knapp','mute_btn','font',this.toggleMute,this);this.toggleMuteBtn.scale.setTo(0.8);this.toggleMuteBtn.position.x+=(this.toggleMuteBtn.width+this.padding)*0.5;this._refreshMuteBtn();this.add(this.toggleMuteBtn);this.fullscreen=new Game.GUI.Button(this.game,this.game.width*0.5,this.resumeBtn.position.y+this.resumeBtn.height+this.padding,'knapp','Toggle\nFullscreen','font',this.toggleFullscreen,this);this.fullscreen.scale.setTo(0.8);this.fullscreen.position.x+=(this.musicBtn.width+this.padding)*0.5;this.add(this.fullscreen);this.alpha=0;this.game.add.tween(this).to({alpha:1},300).start();};Game.GUI.PauseScreen.prototype=Object.create(Phaser.Group.prototype);Game.GUI.PauseScreen.prototype.constructor=Game.GUI.PauseScreen;Game.GUI.PauseScreen.prototype.resume=function(){this.game.add.tween(this).to({alpha:0},300).start().onComplete.add(function(){if(this.game)this.game.state.getCurrentState().resume();},this);};Game.GUI.PauseScreen.prototype.pause=function(){this.game.state.getCurrentState().resume();};Game.GUI.PauseScreen.prototype.toggleMusic=function(){this.game.state.getCurrentState().toggleMusic();this._refreshMusicBtn();};Game.GUI.PauseScreen.prototype.toggleMute=function(){this.game.sound.mute=!this.game.sound.mute;this._refreshMuteBtn();};Game.GUI.PauseScreen.prototype._refreshMusicBtn=function(){this.musicBtn.text=!this.game.musicMuted?'Music: on':'Music: off';};Game.GUI.PauseScreen.prototype._refreshMuteBtn=function(){this.toggleMuteBtn.text=this.game.sound.mute?'Sound: off':'Sound: on';};Game.GUI.PauseScreen.prototype.toggleFullscreen=function(){this.game.state.getCurrentState().toggleFullScreen();};Game.GUI.PauseScreen.prototype.toggleMultiplayer=function(){if(this.game.mpClient){this.game.mpClient.disconnect();this.game.mpClient=null;this.multiplayerBtn.text='Multiplayer:\noff';}else{if(io){var serverUrl='http://{0}:{1}'.format(window.location.hostname,3001);this._createMPClient(serverUrl);this.multiplayerBtn.text='Multiplayer:\non';}}};Game.GUI.PauseScreen.prototype._createMPClient=function(url){this.game.mpClient=new Game.MPClient(this.game,url);};})();(function(){'use strict';Game.HUD=function(game){Phaser.Group.call(this,game);this.fixedToCamera=true;this.createMenu();this.createHelpBtn();return this;};Game.HUD.prototype=Object.create(Phaser.Group.prototype);Game.HUD.prototype.constructor=Game.HUD;Game.HUD.prototype.createMenu=function(){var menuButton=this.menuButton=new Game.GUI.Button(this.game,0,60,'knapp','Menu (P)','font');menuButton.scale.setTo(0.4);menuButton.position.x=menuButton.width*0.5+20;menuButton.onInputDown.add(function(){this.game.state.getCurrentState().togglePause();},this);this.add(menuButton);};Game.HUD.prototype.createHelpBtn=function(){var helpBtn=this.helpBtn=new Game.GUI.Button(this.game,this.game.width,60,'knapp','Help (H)','font');helpBtn.scale.setTo(0.4);helpBtn.position.x-=(helpBtn.width*0.5+20);helpBtn.onInputDown.add(function(){this.game.state.getCurrentState().openHelp();},this);this.add(helpBtn);};})();(function(){'use strict';Game.Init=function(game){this.maxWidth=1280;this.maxHeight=720;};Game.Init.prototype={preload:function(){this.game.load.image('preloadBar','assets/loadingbar.png');this.game.load.image('preloadBarFrame','assets/loadingbar_frame.png');},create:function(){this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL;this.scale.minWidth=256;this.scale.minHeight=196;this.scale.maxWidth=this.maxWidth;this.scale.maxHeight=this.maxHeight;this.scale.refresh();this.stage.disableVisibilityChange=true;this.game.scale.fullScreenTarget=document.getElementById('game');this.game.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL;this.game.scale.enterFullScreen.add(function(){delete this.scale.maxWidth;delete this.scale.maxHeight;},this);this.game.scale.leaveFullScreen.add(function(){this.scale.maxWidth=this.maxWidth;this.scale.maxHeight=this.maxHeight;},this);if(self.localStorage&&self.localStorage.hasOwnProperty('music')){if(self.localStorage.music==='true'){this.game.musicMuted=true;}else{this.game.musicMuted=false;}}
this.state.start('Game.MainMenu');}};})();(function(){'use strict';var specialCollision={bottomRight:[],bottomLeft:[],bottomThird:[],topThird:[],topHalf:[],bottomHalf:[],exclude:[68,102,103,104,105,68,51]};Game.Level=function(game){this.game=game;this.criterias=this.game.criterias=[];this.game.onCriteriaAdd=new Phaser.Signal();this.game.onCriteriaRemove=new Phaser.Signal();this.debugMode=false;this.levelSize={x:0,y:0,width:3000,height:3720};this.AIs={'guard':Game.Controller.AI.Guard};this.sprites={};this.toggleFullScreen=function(){if(this.game.scale.isFullScreen){this.game.scale.stopFullScreen();}else{this.game.scale.startFullScreen(false);}};this.toggleDebug=function(){if(this.debugMode){this.fpsMeter.parent.remove(this.fpsMeter);this.level.debug=false;this.p1.body.checkCollision.up=true;this.p1.body.checkCollision.down=true;this.p1.body.checkCollision.left=true;this.p1.body.checkCollision.right=true;this.p1.body.allowGravity=true;}else{this.game.add.existing(this.fpsMeter);this.level.debug=true;this.p1.body.allowGravity=false;}
if(this.p1){this.p1.godMode=!this.p1.godMode;if(this.p1.godMode){}else{}}
this.level.dirty=true;this.debugMode=!this.debugMode;};this.startTime;this.toggleMusic=function(){this.game.musicMuted=!this.game.musicMuted;if(this.game.musicMuted){if(this.music&&this.music.isPlaying){this.music.fadeOut();}}else{if(this.music&&!this.music.isPlaying){if(this.music.paused){this.music.resume();}else{this.music.fadeIn();}}}
if(self.localStorage){self.localStorage.music=this.game.musicMuted.toString();}
return this.game.musicMuted;};};Game.Level.prototype=Object.create(self.Game.Utils.BaseState.prototype);Game.Level.prototype.constructor=Game.Level;Game.Level.prototype.preload=function(){var preloadBarFrame=this.game.add.image(this.game.width*0.5,this.game.height*0.5,'preloadBarFrame');preloadBarFrame.anchor.set(0.5);var loadingText=this.game.add.bitmapText(this.game.width*0.5,this.game.height*0.3,'font','Loading...',72);loadingText.x-=loadingText.width*0.5;var preloadBar=this.game.add.image(this.game.width*0.5,this.game.height*0.5,'preloadBar');preloadBar.anchor.set(0.5);this.game.load.setPreloadSprite(preloadBar);var assetLoadingText=this.game.add.bitmapText(this.game.width*0.5,this.game.height*0.6,'font','Loading Asset',24);this.game.load.onFileStart.add(function(progress,key,url){if(key==='map'){assetLoadingText.text='Generating world, this can take a while! :D';}else{assetLoadingText.text='Loading file "{0}" from "{1}"'.format(key,url);}
assetLoadingText.updateTransform();assetLoadingText.x=this.game.width*0.5-assetLoadingText.width*0.5;},this);this.helpText='      Walk: Left/Right arrow key\n'+'Jump/Climb: Spacebar\n'+' Next Page: Up arrow key';this.helpBitmapText=this.game.add.bitmapText(0,assetLoadingText.position.y+100,'font',this.helpText,32);this.helpBitmapText.position.x=this.game.width*0.5-this.helpBitmapText.width*0.5;this.game.load.spritesheet('player1','assets/characters/player.png',40,76);this.game.load.spritesheet('spritesheet','assets/spritesheet.png',64,64);this.game.load.audio('jump',['assets/sfx/jump.ogg','assets/sfx/jump.mp3']);this.game.load.audio('objectComplete',['assets/sfx/object_complete.ogg','assets/sfx/object_complete.mp3']);this.game.load.audio('pickupCoin',['assets/sfx/pickup_coin.ogg','assets/sfx/pickup_coin.mp3']);this.game.load.audio('thud',['assets/sfx/thud.ogg','assets/sfx/thud.mp3']);this.game.load.audio('footstep',['assets/sfx/footstep.ogg','assets/sfx/footstep.mp3']);this.game.load.audio('boss',['assets/music/boss.mp3','assets/music/boss.ogg']);this.game.load.audio('truddelutt',['assets/music/truddelutt.mp3','assets/music/truddelutt.ogg']);this.game.load.audio('truddelutt_orgel',['assets/music/truddelutt_orgel.mp3','assets/music/truddelutt_orgel.ogg']);this.game.load.audio('lugnofin',['assets/music/Lugn_och_Fin_Symaskin.mp3','assets/music/Lugn_och_Fin_Symaskin.ogg']);this.game.load.audio('byggarebob',['assets/music/byggarebob.mp3','assets/music/byggarebob.ogg']);this.game.load.image('dialoguePanel','assets/dialoguePanel.png');this.game.load.image('grasshopper','assets/characters/grasshopper256.png');this.game.load.image('octopus','assets/characters/octopus.png');this.game.load.image('bob','assets/characters/bob.png');this.game.load.image('ornithologist','assets/characters/ornithologist.png');this.game.load.image('ladydog','assets/characters/ladydog.png');this.game.load.image('sidecut','assets/characters/sidecut.png');this.game.load.image('florence','assets/characters/florence.png');this.game.load.image('mamabirdie','assets/characters/mamabirdie.png');this.game.load.image('peeti','assets/characters/peeti.png');this.game.load.image('guard','assets/characters/guard.png');this.game.load.image('gris','assets/characters/gris.png');this.game.load.image('apan','assets/characters/apan.png');this.game.load.image('delilah','assets/characters/delilah.png');this.game.load.spritesheet('torch','assets/items/torch.png',16,52);this.game.load.spritesheet('portal','assets/items/portal.png',200,256);this.game.load.image('batteria','assets/items/batteria.png');this.game.load.image('pearl','assets/items/pearl.png');this.game.load.image('manick','assets/items/manick.png');this.game.load.image('egg','assets/items/egg.png');this.game.load.image('bone','assets/items/bone.png');this.game.load.spritesheet('bubbles','assets/particles/bubbles.png',64,64);this.game.load.image('dirtParticle','assets/particles/dirt_particle.png');this.game.load.json('dialogues','assets/data/dialogues.json');this.game.load.tilemap('map','assets/map.json',null,Phaser.Tilemap.TILED_JSON);};Game.Level.prototype.generateLevel=function(){this.map=this.game.add.tilemap('map');this.map.addTilesetImage('spritesheet');this.levelSize.width=this.map.width*this.map.tileWidth;this.levelSize.height=this.map.height*this.map.tileHeight;var bmd=this.game.make.bitmapData(this.game.width,this.game.height);this.bg=this.game.add.image(0,0,bmd);this.bg.bmd=bmd;this.paintBG();this.bg.fixedToCamera=true;var width=this.game.width*0.25;var height=this.game.height*0.25;this.behind=this.map.createLayer('behind',width,height);this.behind.overlay='rgba(0,0,0,0.4)';this.behind.scale.setTo(4);this.behind.smoothed=false;this.level=this.map.createLayer('collision',width,height);this.level.scale.setTo(4);this.level.smoothed=false;var firstID=this.map.tilesets[this.map.getTilesetIndex('spritesheet')].firstgid;var collisionTiles=[];_.forEach(this.map.objects,function(objects){_.forEach(objects,function(obj){obj.x*=4;obj.y*=4;obj.width*=4;obj.height*=4;});});_.forEach(this.behind.layer.data,function(e){_.forEach(e,function(t){t.worldX*=4;t.worldY*=4;t.width*=4;t.height*=4;});});_.forEach(this.level.layer.data,function(e){_.forEach(e,function(t){t.worldX*=4;t.worldY*=4;t.width*=4;t.height*=4;if(t.index>-1&&!_.contains(specialCollision.exclude,t.index-firstID)&&!_.contains(collisionTiles,t.index)){collisionTiles.push(t.index);}
if(_.contains(specialCollision.bottomRight,t.index-firstID)){t.slope='HALF_TRIANGLE_BOTTOM_RIGHT';}
if(_.contains(specialCollision.bottomLeft,t.index-firstID)){t.slope='HALF_TRIANGLE_BOTTOM_LEFT';}
if(_.contains(specialCollision.bottomThird,t.index-firstID)){t.worldY+=2*t.height/3;t.height/=3;}
if(_.contains(specialCollision.topThird,t.index-firstID)){t.height/=3;}
if(_.contains(specialCollision.bottomHalf,t.index-firstID)){t.worldY+=t.height*0.5;t.height*=0.5;}
if(_.contains(specialCollision.bottomHalf,t.index-firstID)){t.height*=0.5;}});});this.front=this.map.createLayer('front',width,height);this.front.scale.setTo(4);this.front.smoothed=false;_.forEach(this.front.layer.data,function(e){_.forEach(e,function(t){t.worldX*=4;t.worldY*=4;t.width*=4;t.height*=4;});});this.level.resizeWorld();this.level.renderSettings.enableScrollDelta=false;this.behind.renderSettings.enableScrollDelta=false;this.front.renderSettings.enableScrollDelta=false;this.secrets=[];_.forEach(this.front.layer.data,function(row){_.forEach(row,function(tile){if(tile.index>0&&!_.contains(specialCollision.exclude,tile.index-firstID)){this.secrets.push(tile);}},this);},this);this.map.setLayer(this.level);this.map.setCollision(collisionTiles);};Game.Level.prototype.setUtils=function(){this.fpsMeter=new Game.Utils.FpsMeter(this.game,32,32);this.f2=this.game.input.keyboard.addKey(113);this.f2.onUp.add(function(){this.toggleDebug();},this);this.f11=this.game.input.keyboard.addKey(122);this.f11.onUp.add(function(){this.toggleFullScreen();},this);};Game.Level.prototype.generateDialogues=function(){this.dialogues={};var dialogues=this.game.cache.getJSON('dialogues');_.forEach(dialogues,function(data,key){this.dialogues[key]=new Game.Dialogue(this.game,data.conversation,data.title);},this);this.game.dialogues=this.dialogues;};Game.Level.prototype.generateCriteriaFunctions=function(){this.criteriaFunctions={'activation':function(){return this.activateKey.downDuration(this.time.msMax);},'jump':function(){return this.p1.controller.jump.isDown;},'portalOperational':function(){return this.objectiveManager.isCompleted('needPower');}};};Game.Level.prototype.generateTriggerFunctions=function(){var oldDrag;this.triggerFunctions={'enterWater':function(){this.p1.submerged=true;},'enterLadder':function(){this.p1.climbing=true;},'leaveWater':function(){this.p1.submerged=false;this.p1.resetJump();},'leaveLadder':function(){this.p1.climbing=false;this.p1.resetJump();},'setSlippery':function(){oldDrag=this.p1.desiredDrag.x;this.p1.desiredDrag.x=100;},'resetSlippery':function(){this.p1.desiredDrag.x=oldDrag;},'enableDblJump':function(){this.p1.maxJumps=2;},'acquireFeather':function(){this.game.criterias.push('feather');this.game.onCriteriaAdd.dispatch('feather',this.game.criterias);},'setCheckpoint':function(obj){this.p1.checkpoint=new Phaser.Point(obj.x+obj.width*0.5,obj.y+obj.height*0.5);},'enterSecret':function(){for(var i=0;i<this.secrets.length;i++){this.secrets[i].alpha=0.5;}},'leaveSecret':function(){for(var i=0;i<this.secrets.length;i++){this.secrets[i].alpha=1;}},'resetPlayer':function(){if(this.p1.checkpoint){this.p1.body.checkCollision.up=false;this.p1.body.checkCollision.down=false;this.p1.body.checkCollision.left=false;this.p1.body.checkCollision.right=false;this.game.add.tween(this.p1.position).to({x:this.p1.checkpoint.x,y:this.p1.checkpoint.y}).start().onComplete.add(function(){this.p1._data.prevY=0;this.p1.body.velocity.setTo(0);this.p1.body.checkCollision.up=true;this.p1.body.checkCollision.down=true;this.p1.body.checkCollision.left=true;this.p1.body.checkCollision.right=true;},this);}},'playMusic':function(obj,key,duration,interrupt,loop,volume){if(!key)return;duration=duration||1000;interrupt=interrupt?interrupt==='true':false;loop=loop?loop==='true':false;volume=volume?parseFloat(volume,10):0.3;var addMusic=interrupt||!(this.music&&this.music.isPlaying);if(addMusic){this.triggerFunctions.stopMusic.call(this,obj,duration);this.music=this.game.sound.add(key);if(!this.game.musicMuted){this.music.onDecoded.add(function(){this.music.play('',0,0,loop);this.music.fadeTo(duration,volume);},this);}}},'stopMusic':function(obj,duration){if(this.music&&this.music.isPlaying){duration=duration||1000;this.music.fadeOut(duration);}},'setSpriteFrame':function(obj,id,frame){if(this.sprites[id]){this.sprites[id].frame=parseInt(frame,10);}},'startEnding':function(obj){this.triggerFunctions.playMusic.call(this,obj,'truddelutt_orgel',undefined,'true');this.p1.body.enable=false;this.game.add.tween(this.p1).to({rotation:Math.PI*2},1000,undefined,false,500,-1,false).start();var scaleTween=this.game.add.tween(this.p1.scale).to({x:3,y:3},undefined,undefined,false,500).start();scaleTween.onComplete.add(function(){scaleTween.to({x:6,y:6},1000,undefined,false,undefined,-1,true).start();});var deltaTime=new Date(Date.now()-this.startTime);this.game.add.tween(this.p1).to({alpha:0},5000,Phaser.Easing.Bounce.In,false,500).start().onComplete.add(function(){var bg=this.game.add.bitmapData(this.game.width,this.game.height);var bgImg=this.game.add.image(0,0,bg);bgImg.fixedToCamera=true;bg.fill(0,0,0);var text='The End!\n'+'You Completed the game in {0} minutes and {1} seconds\n'.format(deltaTime.getMinutes(),deltaTime.getSeconds())+'\nIt would be highly appreciated if you could spend 5-10 minutes \nfilling out our survey, which can be found below, \nor at "http://goo.gl/forms/T5vUQISE5I"';var endText=this.game.add.bitmapText(this.game.width*0.5,this.game.height*0.5-100,'font',text,26);endText.align='center';endText.x-=endText.width*0.5;var surveyBtn=new Game.GUI.Button(this.game,this.game.width*0.5,this.padding,'knapp','Open Survey','font',function(){window.open('https://docs.google.com/forms/d/1eMY-jhFSJwzuuoRPk0Sid8m1CYdxSNRBtQsuUatC1vo/viewform?usp=send_form');});surveyBtn.scale.setTo(0.8);surveyBtn.position.y=endText.y+endText.height+surveyBtn.height*0.5+20;var creditText=this.game.add.bitmapText(20,this.game.height-20,'font','The music heard when facing the ornithologist was created by 13NHarri @ Freesound.org',20);bgImg.addChild(surveyBtn);bgImg.addChild(endText);bgImg.addChild(creditText);bgImg.alpha=0;this.game.add.tween(bgImg).to({alpha:1}).start();},this);}};};Game.Level.prototype.generateSprites=function(){_.forEach(this.map.objects['sprites'],function(obj){switch(obj.type){case'torch':var radius=parseInt(obj.properties['radius'],10);var fade=parseFloat(obj.properties['fade'],10);var r=parseInt(obj.properties['r'],10);var g=parseInt(obj.properties['g'],10);var b=parseInt(obj.properties['b'],10);var pixelateValue=parseFloat(obj.properties['pixelateValue'],10);var pulsate=obj.properties['pulsate']?obj.properties['pulsate']!=='false':true;if(obj.properties['torch']!=='false'){var torch=new Phaser.Sprite(this.game,obj.x,obj.y,'torch',0);torch.position.x-=torch.width*0.5;torch.position.y-=torch.height*0.5;torch.animations.add('burn',null,2,true);torch.animations.play('burn');this.game.add.existing(torch);}
var torchLight=new Game.Torch(this.game,obj.x,obj.y,radius,fade,pixelateValue,r,g,b);this.game.add.existing(torchLight);if(pulsate){this.game.add.tween(torchLight.scale).to({x:1.1,y:1.1},1000,undefined,undefined,undefined,-1,true).start();}
break;case'entity':var key=obj.properties['key'];var frame=parseInt(obj.properties['frame'],10);var sprite=this.game.add.sprite(obj.x+obj.width*0.5,obj.y+obj.height*0.5,key,frame,this.entitiesGroup);var id=obj.properties['id'];if(id){this.sprites[id]=sprite;}
console.log(id,sprite);break;case'character':var key=obj.properties['key'];var character=new Game.Character(this.game,obj.x+obj.width*0.5,obj.y+obj.height*0.5,key);var AI=obj.properties['AI'];switch(AI){case'guard':character.controller=new Game.Controller.AI.Guard(this.game,character,this.p1,obj.properties);break;case'ornithologist':character.controller=new Game.Controller.AI.Ornithologist(this.game,character,this.p1,obj.properties);break;case'pacing':character.controller=new Game.Controller.AI.Pacing(this.game,character,this.p1,obj.properties);break;default:console.log('AI type',AI,'is not in use');}
if(obj.properties['allowGravity']){character.body.allowGravity=obj.properties['allowGravity']==='true';}
if(obj.properties['floaty']){var floaty=parseInt(obj.properties['floaty'],10);this.game.add.tween(character.position).from({y:obj.y+floaty*0.5}).to({y:obj.y-floaty*0.5},1000,undefined,true,undefined,-1,true);}
var id=obj.properties['id'];if(id){this.sprites[id]=sprite;}
this.entitiesGroup.add(character);break;default:console.log('Did not recognize sprite type: ',obj.type);}},this);};Game.Level.prototype.generateObjects=function(){_.forEach(this.map.objects['objects'],function(obj){switch(obj.type){case'spawn':if(this.p1){var x=obj.x+obj.width/2;var y=obj.y+obj.height/2;this.p1.reset(x,y);this.p1._cache[4]=0;}
break;case'dialogue':var dialogueKey=obj.properties.dialogue;var dialogue=this.dialogues[dialogueKey];var listen=obj.properties['listen']?obj.properties['listen'].split(','):undefined;var onListenDialogue=obj.properties['onListenDialogue']?this.dialogues[obj.properties['onListenDialogue']]:undefined;var criteria=obj.properties['criteriaFunction']||'';criteria=this.criteriaFunctions[criteria];if(dialogue){var trigger=new Game.Trigger.ZoneTrigger(this.game,true,new Phaser.Rectangle(obj.x,obj.y,obj.width,obj.height),this.p1,criteria,undefined,this);this.triggerManager.addTrigger(trigger);trigger.onActive.add(function(){this.dialogueManager.setDialogue(dialogue);},this);trigger.onInactive.add(function(){this.dialogueManager.hidden=true;},this);if(listen&&onListenDialogue){this.game.objectiveManager.onObjectiveComplete.add(function(objective){if(objective.properties.id&&_.contains(listen,objective.properties.id)){var oldDialogue=dialogue;dialogue=onListenDialogue;if(oldDialogue.isOpen){this.dialogueManager.setDialogue(dialogue);}}},this);}}
break;case'criteria':var criteriaFunction;if(obj.properties['function']&&this.criteriaFunctions[obj.properties['function']]){criteriaFunction=this.criteriaFunctions[obj.properties['function']];}
var trigger=new Game.Trigger.ZoneTrigger(this.game,true,new Phaser.Rectangle(obj.x,obj.y,obj.width,obj.height),this.p1,criteriaFunction,undefined,this);this.triggerManager.addTrigger(trigger);trigger.onActive.add(function(trigger){trigger.enabled=false;this.game.criterias.push(obj.name);this.game.onCriteriaAdd.dispatch(obj.name,this.game.criterias);},this);if(obj.properties.inactivate){trigger.onInactive.add(function(){trigger.enabled=true;_.remove(this.game.criterias,obj.name);this.game.onCriteriaRemove.dispatch(obj.name,this.game.criterias);},this);}
break;case'trigger':var onEnter=obj.properties['enter']||'';var onLeave=obj.properties['leave']||'';onEnter=this.triggerFunctions[onEnter];onLeave=this.triggerFunctions[onLeave];if(typeof onEnter==='undefined'&&typeof onLeave==='undefined')return;var enterCriteria=obj.properties['enterCriteria']||'';var leaveCriteria=obj.properties['leaveCriteria']||'';enterCriteria=this.criteriaFunctions[enterCriteria];leaveCriteria=this.criteriaFunctions[leaveCriteria];var rectangles=[new Phaser.Rectangle(obj.x,obj.y,obj.width,obj.height)];if(obj.properties['part']){var part=obj.properties['part'];var parts=_.filter(this.map.objects['objects'],{type:'part',name:part});_.forEach(parts,function(partObj){rectangles.push(new Phaser.Rectangle(partObj.x,partObj.y,partObj.width,partObj.height));});}
var trigger=new Game.Trigger.ZoneTrigger(this.game,true,rectangles,this.p1,enterCriteria,leaveCriteria,this);var enterArgs=obj.properties['enterArgs']?obj.properties['enterArgs'].split(','):[];var leaveArgs=obj.properties['leaveArgs']?obj.properties['leaveArgs'].split(','):[];enterArgs.splice(0,0,obj);leaveArgs.splice(0,0,obj);for(var i=0;i<enterArgs.length;i++){var parsed=parseFloat(enterArgs[i]);enterArgs[i]=isNaN(parsed)?enterArgs[i]:parsed;}
for(var i=0;i<leaveArgs.length;i++){var parsed=parseFloat(leaveArgs[i]);leaveArgs[i]=isNaN(parsed)?leaveArgs[i]:parsed;}
this.triggerManager.addTrigger(trigger);trigger.onActive.add(function(){if(onEnter){onEnter.apply(this,enterArgs);}},this);trigger.onInactive.add(function(){if(onLeave){onLeave.apply(this,leaveArgs);}},this);break;}},this);};Game.Level.prototype.spawnPlayer=function(x,y){this.p1=new Game.Player(this.game,x||0,y||0);this.game.add.existing(this.p1);this.entitiesGroup.add(this.p1);this.game.camera.follow(this.p1);this.game.camera.deadzone=this.getCameraDeadzone();};Game.Level.prototype.create=function(){this.game.physics.startSystem(Phaser.Physics.ARCADE);this.game.physics.arcade.gravity=Game.gravity;this.game.physics.arcade.TILE_BIAS=64;this.activateKey=this.game.input.keyboard.addKey(Phaser.Keyboard.UP);this.setUtils();this.generateLevel();this.generateDialogues();this.generateCriteriaFunctions();this.generateTriggerFunctions();this.entitiesGroup=this.game.entitiesGroup=this.game.add.group();this.entitiesGroup.enableBody=true;this.spawnPlayer();this.HUD=new Game.HUD(this.game);this.objectiveManager=this.game.objectiveManager=new Game.ObjectiveManager(this.game,this.HUD,this.game.width*0.5,20);this.dialogueManager=this.game.dialogueManager=new Game.DialogueManager(this.game,this.HUD);this.triggerManager=this.game.triggerManager=new Game.Trigger.TriggerManager(this.game);this.generateObjects();this.generateSprites();this.entitiesGroup.bringToTop(this.p1);this.game.world.bringToTop(this.entitiesGroup);this.game.world.bringToTop(this.front);this.objectiveManager.createObjectives(this.map,this.map.objects['objectives'],this.p1);this.activateKey.onDown.add(function(){this.dialogueManager.nextSlide();},this);this.game.input.keyboard.addKey(Phaser.Keyboard.P).onUp.add(this.togglePause,this);this.game.input.keyboard.addKey(Phaser.Keyboard.H).onUp.add(this.toggleHelp,this);this.game.world.bringToTop(this.HUD);this.paintBG();this.startTime=Date.now();};Game.Level.prototype.update=function(){this.game.physics.arcade.collide(this.entitiesGroup,this.level);};Game.Level.prototype.render=function(){if(this.debugMode){this.entitiesGroup.forEach(function(entity){this.game.debug.body(entity);},this);}};Game.Level.prototype.pause=function(){this.paused=true;this.pauseScreen=new Game.GUI.PauseScreen(this.game,this.HUD);};Game.Level.prototype.resume=function(){this.paused=false;this.pauseScreen.destroy();};Game.Level.prototype.togglePause=function(){if(this.paused){this.pauseScreen.resume();}else{this.pause();}};Game.Level.prototype.closeHelp=function(){if(this.helpScreen.exists){this.helpScreen.destroy();this.helpScreen=null;}};Game.Level.prototype.openHelp=function(){if(this.helpScreen)return;this.helpScreen=new Game.GUI.HelpScreen(this.game,this.HUD);};Game.Level.prototype.toggleHelp=function(){if(this.helpScreen){this.helpScreen.closeHelp();}else{this.openHelp();}};var offset={value:50};Game.Level.prototype.paintBG=function(){var steps=30;var pixelPerStep=this.game.height/steps;var bluePerStep=200/steps;var greenPerStep=100/steps;var redPerStep=50/steps;var red,green,blue,color,rnd;for(var y=0;y*pixelPerStep<=this.game.height;y++){red=Math.floor(redPerStep*y+offset.value);green=Math.floor(greenPerStep*y+offset.value*1.5);blue=Math.floor(bluePerStep*y+offset.value*2);color='rgb({0},{1},{2})'.format(red,green,blue);this.bg.bmd.rect(0,(steps-y)*pixelPerStep,this.game.width,pixelPerStep,color);}};})();(function(){function bind(context,func){return function(){func.apply(context,arguments);};}
Game.MPClient=function(game,url){this.game=game;this.url=url;this.id=undefined;this.socket=undefined;this.characters={};this.state=this.game.state.getCurrentState();this.p1=this.state.p1;this.connect();this.setEvents();};Game.MPClient.prototype.constructor=Game.MPClient;Game.MPClient.prototype.connect=function(){this.socket=new io(this.url,{'force new connection':true});};Game.MPClient.prototype.sendPosition=function(){var pos={x:this.p1.position.x,y:this.p1.position.y};this.socket.emit('action',{position:pos});setTimeout(bind(this,this.sendPosition),500);};Game.MPClient.prototype.setEvents=function(){this.socket.on('id',bind(this,this.onID));this.socket.on('new',bind(this,this.onNew));this.socket.on('delete',bind(this,this.onDelete));this.socket.on('position',bind(this,this.onPosition));this.socket.on('action',bind(this,this.onAction));this.bindController();};Game.MPClient.prototype.bindController=function(){this.p1.controller.down.onDown.add(this.sendController,this);this.p1.controller.down.onUp.add(this.sendController,this);this.p1.controller.left.onDown.add(this.sendController,this);this.p1.controller.left.onUp.add(this.sendController,this);this.p1.controller.right.onDown.add(this.sendController,this);this.p1.controller.right.onUp.add(this.sendController,this);this.p1.controller.jump.onDown.add(this.sendController,this);this.p1.controller.jump.onUp.add(this.sendController,this);};Game.MPClient.prototype.unbindController=function(){this.p1.controller.down.onDown.remove(this.sendController,this);this.p1.controller.down.onUp.remove(this.sendController,this);this.p1.controller.left.onDown.remove(this.sendController,this);this.p1.controller.left.onUp.remove(this.sendController,this);this.p1.controller.right.onDown.remove(this.sendController,this);this.p1.controller.right.onUp.remove(this.sendController,this);this.p1.controller.jump.onDown.remove(this.sendController,this);this.p1.controller.jump.onUp.remove(this.sendController,this);};Game.MPClient.prototype.sendController=function(key,state){var action={};action[key]=state;this.socket.emit('action',action);};Game.MPClient.prototype.onID=function(data){this.id=data.id;var pos={x:this.p1.position.x,y:this.p1.position.y};var key=this.p1.key;this.socket.emit('new',{position:pos,texture:key});this.sendPosition();};Game.MPClient.prototype.onNew=function(data){if(data.id===this.id)return;var controller=new Game.Controller(this.game);var character=new Game.Character(this.game,data.position.x,data.position.y,data.texture||'grasshopper',controller);this.game.entitiesGroup.add(character);this.characters[data.id]=character;};Game.MPClient.prototype.onDelete=function(data){if(data.id===this.id)return;var character=this.characters[data.id];this.game.entitiesGroup.remove(character,true);this.characters[data.id]=null;};Game.MPClient.prototype.onPosition=function(data){if(data.id===this.id)return;var character=this.characters[data.id];if(!character)return;character.position.setTo(data.position.x,data.position.y);};Game.MPClient.prototype.onAction=function(data){_.forEach(data,function(actions,id){if(id===this.id)return;var character=this.characters[id];_.forEach(actions,function(action){var type=_.keys(action)[0];var value=action[type];switch(type){case'left':case'up':case'down':case'right':case'jump':if(value){character.controller[type].setDown();}else{character.controller[type].setUp();}
break;case'position':if(character.position.distance(value)>100){this.game.add.tween(character.position).to(value,100).start();}}},this);},this);};Game.MPClient.prototype.disconnect=function(){_.forEach(this.characters,function(character){this.game.entitiesGroup.remove(character,true);},this);this.unbindController();this.characters=null;this.socket.disconnect();this.socket=null;};})();(function(){'use strict';Game.MainMenu=function(game){};Game.MainMenu.prototype.constructor=Game.MainMenu;Game.MainMenu.prototype.preload=function(){this.game.load.image('knapp','assets/knapp.png');this.game.load.bitmapFont('font','assets/bmfont_0.png','assets/bmfont.fnt');this.game.load.image('splash','assets/ui/splash.png');};Game.MainMenu.prototype.create=function(){if(location.hostname==='localhost'){this.startLevel();return;}
var bmd=this.game.make.bitmapData(this.game.width,this.game.height);bmd.processPixelRGB(this.noise,this);bmd.dirty=true;this.bg=this.game.add.image(0,0,bmd);this.bg.bmd=bmd;this.splash=this.game.add.image(0,0,'splash');this.splash.tint=0x888888;this.btnPlay=new Game.GUI.Button(this.game,this.game.width*0.5,this.game.height*0.5,'knapp','Play','font',this.startLevel,this);this.game.world.add(this.btnPlay);this.btnPlay.anchor.setTo(0.5);};Game.MainMenu.prototype.startLevel=function(){this.state.start('Game.Level');};Game.MainMenu.prototype.noise=function(pixel){var val=((50*Math.random())|0);pixel.r=val;pixel.g=val;pixel.b=val;pixel.a=50+val;return pixel;};})();(function(){'use strict';Game.ObjectiveManager.A2BObjective=function(game,objectiveManager,trigger,tilemap,object,player,dependencies,endTrigger){Game.ObjectiveManager.Objective.call(this,game,objectiveManager,trigger,tilemap,object,player,dependencies);this.endTrigger=endTrigger;this.endTrigger.onActive.add(function(){if(this.objectiveManager.isActive(this)){this.onCompletion.dispatch(this);}},this);this.trigger.onActive.add(this.enableEndTrigger,this);this.removeOnInactive=false;};Game.ObjectiveManager.A2BObjective.prototype=Object.create(Game.ObjectiveManager.Objective.prototype);Game.ObjectiveManager.A2BObjective.prototype.constructor=Game.ObjectiveManager.A2BObjective;Game.ObjectiveManager.A2BObjective.prototype.enableEndTrigger=function(){this.endTrigger.enabled=true;};})();(function(){'use strict';Game.ObjectiveManager.CollectObjective=function(game,objectiveManager,trigger,tilemap,object,player,dependencies,toCollectGroup,endTrigger){Game.ObjectiveManager.Objective.call(this,game,objectiveManager,trigger,tilemap,object,player,dependencies);this.toCollectGroup=toCollectGroup;this.isReturn=this.object.properties['return']?this.object.properties['return']==='true':false;this.endTrigger=endTrigger;if(this.endTrigger){this.isReturn=true;}
this.collectSFX=this.game.add.audio('pickupCoin');this.removeOnInactive=false;this.updateStatusText();};Game.ObjectiveManager.CollectObjective.prototype=Object.create(Game.ObjectiveManager.Objective.prototype);Game.ObjectiveManager.CollectObjective.prototype.constructor=Game.ObjectiveManager.CollectObjective;Game.ObjectiveManager.CollectObjective.prototype.update=function(){Game.ObjectiveManager.Objective.prototype.update.call(this);this.toCollectGroup.forEachAlive(function(toCollectItem){if(this.game.physics.arcade.intersects(this.player.body,toCollectItem.body)){this.collectSFX.play();toCollectItem.collected=true;toCollectItem.kill();this.updateStatusText();this.checkWin();if(toCollectItem.activate){this.activate();}}},this);if(this.isReturn){this.checkWin();}};Game.ObjectiveManager.CollectObjective.prototype.updateStatusText=function(){if(this.isReturn&&this.collected>=this.toCollect){this.statusText=this.object.properties.statusReturn||this.statusTemplate.format(this.collected,this.toCollect);}else{this.statusText=this.statusTemplate.format(this.collected,this.toCollect);}};Game.ObjectiveManager.CollectObjective.prototype.checkWin=function(){if(this.collected>=this.toCollect&&!this.completed){if(!this.isReturn){this.onCompletion.dispatch(this);}else if(this.endTrigger){if(this.endTrigger.isActive){this.onCompletion.dispatch(this);}}else if(this.trigger.isActive){this.onCompletion.dispatch(this);}}};Object.defineProperty(Game.ObjectiveManager.CollectObjective.prototype,'toCollect',{get:function(){return this.toCollectGroup.length;}});Object.defineProperty(Game.ObjectiveManager.CollectObjective.prototype,'collected',{get:function(){var collected=0;for(var i=0;i<this.toCollectGroup.children.length;i++){if(this.toCollectGroup.children[i].collected){collected++;}}
return collected;}});})();(function(){'use strict';Game.ObjectiveManager.CriteriaObjective=function(game,objectiveManager,trigger,tilemap,object,player,dependencies,criterias){Game.ObjectiveManager.Objective.call(this,game,objectiveManager,trigger,tilemap,object,player,dependencies);this.criterias=criterias;this.isReturn=this.properties['return']==='true';this.game.onCriteriaAdd.add(this.checkWin,this);this.trigger.onActive.add(this.checkWin,this);};Game.ObjectiveManager.CriteriaObjective.prototype=Object.create(Game.ObjectiveManager.Objective.prototype);Game.ObjectiveManager.CriteriaObjective.prototype.constructor=Game.ObjectiveManager.CriteriaObjective;Game.ObjectiveManager.CriteriaObjective.prototype.checkWin=function(){var contained=0;for(var i=0;i<this.game.criterias.length;i++){for(var u=0;u<this.criterias.length;u++){if(this.criterias[u]===this.criterias[i]){contained++;}}}
if(contained===this.criterias.length&&(!this.isReturn||this.trigger.isActive)){this.onCompletion.dispatch(this);this.game.onCriteriaAdd.remove(this.checkWin,this);this.trigger.onActive.remove(this.checkWin,this);}else if(contained===this.criterias.length&&this.isReturn){this.statusText=this.object.properties.statusReturn;}};})();(function(){'use strict';var textureKey='player1';Game.Player=function(game,x,y){Game.Character.call(this,game,x,y,textureKey);this.controller=new Game.Controller.KeyboardController(this.game,this);this.animations.add('run',[1,2,3,4],10);this.animations.add('still',[0]);return this;};Game.Player.prototype=Object.create(Game.Character.prototype);Game.Player.prototype.constructor=Game.Player;Game.Player.prototype.update=function(){Game.Character.prototype.update.call(this);if(this.states.tryWalking){this.animations.play('run');}else if(this.states.still){this.animations.play('still');}};})();(function(){'use strict';var torchCache={};Game.Shadow=function(game){this.shadowTexture=game.add.bitmapData(game.width,game.height);Phaser.Image.call(this,game,0,0,this.shadowTexture);this.fixedToCamera=true;this.blendMode=Phaser.blendModes.LUMINOSITY;this.shadowTexture.fill(0,0,0,0.1);};Game.Shadow.prototype=Object.create(Phaser.Image.prototype);Game.Shadow.prototype.constructor=Game.Shadow;Game.Torch=function(game,x,y,radius,fade,value,r,g,b){this.torchTexture=torchCache[getCacheString(radius,fade,r,g,b,value)]?torchCache[getCacheString(radius,fade,r,g,b,value)]:Game.Torch.createRadial(game,radius,fade,value,r,g,b);Phaser.Image.call(this,game,x,y,this.torchTexture);this.anchor.setTo(0.5);this.blendMode=Phaser.blendModes.ADD;this.alpha=0.5;};Game.Torch.prototype=Object.create(Phaser.Image.prototype);Game.Torch.prototype.constructor=Game.Torch;Game.Torch.createRadial=function(game,radius,fade,value,r,g,b){radius=radius||200;fade=fade||0.1;r=r||255;g=g||150;b=b||100;value=value||20;var bitmapData=new Phaser.BitmapData(game,'radial'+radius,radius*2,radius*2);var gradient=bitmapData.context.createRadialGradient(radius,radius,radius*fade,radius,radius,radius);gradient.addColorStop(0,'rgba({0}, {1}, {2}, 1.0)'.format(r,g,b));gradient.addColorStop(1,'rgba({0}, {1}, {2}, 0.0)'.format(r,g,b));bitmapData.circle(radius,radius,radius,gradient);bitmapData.context.mozImageSmoothingEnabled=false;bitmapData.context.webkitImageSmoothingEnabled=false;bitmapData.context.imageSmoothingEnabled=false;var bmd=new Phaser.BitmapData(game,'radialSmall'+radius,radius*2/value,radius*2/value);bmd.context.drawImage(bitmapData.canvas,0,0,bmd.width,bmd.height);bitmapData.context.drawImage(bmd.canvas,0,0,bitmapData.width,bitmapData.height);torchCache[getCacheString(radius,fade,r,g,b,value)]=bitmapData;return bitmapData;};function getCacheString(radius,fade,r,g,b,value){return String(radius)+String(fade)+String(r)+String(g)+String(b)+String(value);}})();(function(){'use strict';Game.Trigger=function(game,enabled){this.game=game;this.onActive=new Phaser.Signal();this.onActive.add(this._onActiveHandler,this);this.onInactive=new Phaser.Signal();this.onInactive.add(this._onInactiveHandler,this);this.enabled=typeof enabled!=='undefined'?enabled:true;this.isActive=false;this.isInactive=true;};Game.Trigger.prototype.constructor=Game.Trigger;Game.Trigger.prototype._onActiveHandler=function(){this.isActive=true;this.isInactive=false;};Game.Trigger.prototype._onInactiveHandler=function(){this.isActive=false;this.isInactive=true;};})();(function(){'use strict';Game.Trigger.TriggerManager=function(game){Phaser.Group.call(this,game,undefined,'TriggerManager');this.triggers=[];};Game.Trigger.TriggerManager.prototype=Object.create(Phaser.Group.prototype);Game.Trigger.TriggerManager.prototype.constructor=Game.Trigger.TriggerManager;Game.Trigger.TriggerManager.prototype.addTrigger=function(trigger){this.triggers.push(trigger);};Game.Trigger.TriggerManager.prototype.update=function(){Phaser.Group.prototype.update.call(this);for(var i=0;i<this.triggers.length;i++){this.triggers[i].update();}};})();(function(){'use strict';Game.Trigger.ZoneTrigger=function(game,enabled,zone,toTrack,criteriaActive,criteriaInactive,thisArg){Game.Trigger.call(this,game,enabled);this.zones=zone;this.toTrack=toTrack;this._wasInZone=[];if(this.zones&&this.zones.constructor!==Array){this.zones=[this.zones];}
if(this.toTrack&&this.toTrack.constructor!==Array){this.toTrack=[this.toTrack];}
this.criteriaActive=criteriaActive;this.criteriaInactive=criteriaInactive;this.thisArg=thisArg;this._broadTrigger=undefined;if(this.zones.length>1){var padding=20;var top=Number.MAX_VALUE,left=Number.MAX_VALUE,right=Number.MIN_VALUE,bottom=Number.MIN_VALUE;_.forEach(this.zones,function(zone){top=Math.min(top,zone.top);left=Math.min(left,zone.left);right=Math.max(right,zone.right);bottom=Math.max(bottom,zone.bottom);});var rect=new Phaser.Rectangle(left-padding,top-padding,right-left+padding*2,bottom-top+padding*2);this._broadTrigger=new Game.Trigger.ZoneTrigger(this.game,true,rect,this.toTrack);this.game.triggerManager.addTrigger(this._broadTrigger);}
this._refreshInZone();return this;};Game.Trigger.ZoneTrigger.prototype=Object.create(Game.Trigger.prototype);Game.Trigger.ZoneTrigger.prototype.constructor=Game.Trigger.ZoneTrigger;Game.Trigger.ZoneTrigger.prototype._refreshInZone=function(){this._wasInZone=[];for(var i=0;i<this.toTrack.length;i++){this._wasInZone.push([]);for(var x=0;x<this.zones.length;x++){this._wasInZone[i].push(false);}}};Game.Trigger.ZoneTrigger.prototype.update=function(){if(!this.enabled)return;if(this._broadTrigger&&!this._broadTrigger.isActive)return;var iToTrack,iZone,insideAny;for(iToTrack=0;iToTrack<this.toTrack.length;iToTrack++){for(iZone=0;iZone<this.zones.length;iZone++){this._wasInZone[iToTrack][iZone]=this.zones[iZone].contains(this.toTrack[iToTrack].position.x,this.toTrack[iToTrack].position.y);if(this._wasInZone[iToTrack][iZone]){insideAny=true;break;}}
if(insideAny)break;}
if(!this.isActive&&insideAny){if(!this.criteriaActive){this.onActive.dispatch(this,this.toTrack[iToTrack]);}else if(this.criteriaActive.call(this.thisArg)){this.onActive.dispatch(this,this.toTrack[iToTrack]);}}else if(this.isActive&&!insideAny){if(!this.criteriaInactive){this.onInactive.dispatch(this,this.toTrack[iToTrack]);}else if(this.criteriaInactive.call(this.thisArg)){this.onInactive.dispatch(this,this.toTrack[iToTrack]);}}};Game.Trigger.ZoneTrigger.prototype.debug=function(){_.forEach(this.zones,function(zone,izones){this.game.debug.geom(zone);},this);};})();(function(){'use strict';PIXI.BitmapText.prototype.maxWidth=0;PIXI.BitmapText.prototype.updateText=function()
{var data=PIXI.BitmapText.fonts[this.fontName];var pos=new PIXI.Point();var prevCharCode=null;var chars=[];var maxLineWidth=0;var lineWidths=[];var line=0;var scale=this.fontSize/data.size;var lastSpace=-1;for(var i=0;i<this.text.length;i++)
{var charCode=this.text.charCodeAt(i);lastSpace=/(\s)/.test(this.text.charAt(i))?i:lastSpace;if(/(?:\r\n|\r|\n)/.test(this.text.charAt(i)))
{lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue;}
if(lastSpace!==-1&&this.maxWidth&&pos.x*scale>this.maxWidth){chars.splice(lastSpace,i-lastSpace);i=lastSpace;lastSpace=-1;lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue;}
var charData=data.chars[charCode];if(!charData)continue;if(prevCharCode&&charData.kerning[prevCharCode])
{pos.x+=charData.kerning[prevCharCode];}
chars.push({texture:charData.texture,line:line,charCode:charCode,position:new PIXI.Point(pos.x+charData.xOffset,pos.y+charData.yOffset)});pos.x+=charData.xAdvance;prevCharCode=charCode;}
lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);var lineAlignOffsets=[];for(i=0;i<=line;i++)
{var alignOffset=0;if(this.style.align==='right')
{alignOffset=maxLineWidth-lineWidths[i];}
else if(this.style.align==='center')
{alignOffset=(maxLineWidth-lineWidths[i])/2;}
lineAlignOffsets.push(alignOffset);}
var lenChildren=this.children.length;var lenChars=chars.length;var tint=this.tint||0xFFFFFF;for(i=0;i<lenChars;i++)
{var c=i<lenChildren?this.children[i]:this._pool.pop();if(c)c.setTexture(chars[i].texture);else c=new PIXI.Sprite(chars[i].texture);c.position.x=(chars[i].position.x+lineAlignOffsets[chars[i].line])*scale;c.position.y=chars[i].position.y*scale;c.scale.x=c.scale.y=scale;c.tint=tint;if(!c.parent)this.addChild(c);}
while(this.children.length>lenChars)
{var child=this.getChildAt(this.children.length-1);this._pool.push(child);this.removeChild(child);}
this.textWidth=maxLineWidth*scale;this.textHeight=(pos.y+data.lineHeight)*scale;};})();(function(){'use strict';Phaser.Sound.prototype.playFrom=function(point,marker,position,volume,loop,forceRestart){var distance=point.distance(this.game.state.getCurrentState().p1.position);var realVolume=Math.max(0,this.game.width*0.5-distance)/(this.game.width*0.5);volume=(volume||1)*realVolume;if(volume===0)return;this.play(marker,position,volume,loop,forceRestart);};Phaser.SoundManager.prototype.playFrom=function(point,key,volume,loop){var sound=this.add(key,volume,loop);sound.playFrom(point);return sound;};})();Phaser.SoundManager.prototype.toggleMute=function(){this.mute=!this.mute;return this.mute;};(function(){'use strict';Phaser.TilemapLayer.prototype.resizeWorld=function(){this.game.world.setBounds(0,0,this.layer.widthInPixels*this.scale.x,this.layer.heightInPixels*this.scale.y);};Phaser.TilemapLayer.prototype.postUpdate=function(x,y,width,height,collides,interestingFace){Phaser.Image.prototype.postUpdate.call(this);var camera=this.game.camera;this.scrollX=camera.x*this.scrollFactorX*(1/this.scale.x);this.scrollY=camera.y*this.scrollFactorY*(1/this.scale.y);this.render();if(this._cache[7]===1)
{this.position.x=(camera.view.x+this.cameraOffset.x)/camera.scale.x;this.position.y=(camera.view.y+this.cameraOffset.y)/camera.scale.y;}};Phaser.TilemapLayer.prototype.getTiles=function(x,y,width,height,collides,interestingFace){if(typeof collides==='undefined'){collides=false;}
if(typeof interestingFace==='undefined'){interestingFace=false;}
var fetchAll=!(collides||interestingFace);x=this._fixX(x);y=this._fixY(y);var tx=Math.floor(x/(this.scale.x*this._mc.cw));var ty=Math.floor(y/(this.scale.y*this._mc.ch));var tw=Math.ceil((x+width)/(this.scale.x*this._mc.cw))-tx;var th=Math.ceil((y+height)/(this.scale.x*this._mc.ch))-ty;while(this._results.length)
{this._results.pop();}
for(var wy=ty;wy<ty+th;wy++)
{for(var wx=tx;wx<tx+tw;wx++)
{var row=this.layer.data[wy];if(row&&row[wx])
{if(fetchAll||row[wx].isInteresting(collides,interestingFace))
{this._results.push(row[wx]);}}}}
return this._results;};Phaser.TilemapLayer.prototype.renderRegion=function(scrollX,scrollY,left,top,right,bottom){var context=this.context;var width=this.layer.width;var height=this.layer.height;var tw=this._mc.tileWidth;var th=this._mc.tileHeight;var tilesets=this._mc.tilesets;var lastAlpha=NaN;if(!this._wrap)
{if(left<=right)
{left=Math.max(0,left);right=Math.min(width-1,right);}
if(top<=bottom)
{top=Math.max(0,top);bottom=Math.min(height-1,bottom);}}
var baseX=(left*tw)-scrollX;var baseY=(top*th)-scrollY;var normStartX=(left+((1<<20)*width))%width;var normStartY=(top+((1<<20)*height))%height;var tx,ty,x,y,xmax,ymax;context.fillStyle=this.tileColor;for(y=normStartY,ymax=bottom-top,ty=baseY;ymax>=0;y++,ymax--,ty+=th)
{if(y>=height){y-=height;}
var row=this.layer.data[y];for(x=normStartX,xmax=right-left,tx=baseX;xmax>=0;x++,xmax--,tx+=tw)
{if(x>=width){x-=width;}
var tile=row[x];if(!tile||tile.index<0)
{continue;}
var index=tile.index;var set=tilesets[index];if(set===undefined)
{set=this.resolveTileset(index);}
if(tile.alpha!==lastAlpha&&!this.debug)
{context.globalAlpha=tile.alpha;lastAlpha=tile.alpha;}
if(set)
{set.draw(context,tx,ty,index);if(this.overlay){this.context.fillStyle=this.overlay;context.fillRect(tx,ty,tw,th);this.context.fillStyle=this.tileColor;}}
else if(this.debugSettings.missingImageFill)
{context.fillStyle=this.debugSettings.missingImageFill;context.fillRect(tx,ty,tw,th);}
if(tile.debug&&this.debugSettings.debuggedTileOverfill)
{context.fillStyle=this.debugSettings.debuggedTileOverfill;context.fillRect(tx,ty,tw,th);}}}};var cache={};Phaser.TilemapLayer.prototype.generateRegion=function(x,y,width,height,overlay){var bmd=new Phaser.BitmapData(this.game,'generatedRegion',width,height);bmd.context.fillStyle=overlay;var tiles=this.getTiles(x,y,width,height);var cacheKey=generateCacheKey(tiles,overlay);if(isEmpty(tiles)){return;}
if(cache[cacheKey]){return cache[cacheKey];}
var tile,set;for(var i=0;i<tiles.length;i++){tile=tiles[i];set=this._mc.tilesets[tile.index];if(!set)
{set=this.resolveTileset(tile.index);if(!set)continue;}
set.draw(bmd.context,tile.worldX-x,tile.worldY-y,tile.index);if(overlay){bmd.context.fillRect(tile.worldX-x,tile.worldY-y,tile.width,tile.height);}}
cache[cacheKey]=bmd;return bmd;};function isEmpty(tiles){for(var i=0;i<tiles.length;i++){if(tiles[i].index!==-1)return false;}
return true;}
function generateCacheKey(tiles,overlay){var str=String(overlay);for(var i=0;i<tiles.length;i++){str+=tiles[i].index;}
return str;}})();(function(){'use strict';var update=Phaser.World.prototype.update;Phaser.World.prototype.update=function(){var state=this.game.state.getCurrentState();if(state.paused)return;update.call(this);};var postUpdate=Phaser.World.prototype.postUpdate;Phaser.World.prototype.postUpdate=function(){var state=this.game.state.getCurrentState();if(state.paused)return;postUpdate.call(this);};var preUpdate=Phaser.World.prototype.preUpdate;Phaser.World.prototype.preUpdate=function(){var state=this.game.state.getCurrentState();if(state.paused)return;preUpdate.call(this);};})();